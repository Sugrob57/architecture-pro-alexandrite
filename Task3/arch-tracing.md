# Архитектурное решение по трейсингу

## Мотивация

### Внедрение трейсинга позволит:

1. Сократить время реакции на ошибки при обработке заказов в API для партнеров - можно получать статистику по выполнению заказов, настраивать автматические алерты при зависании.
2. Сократь время обработки жалом от B2C-клиентов, сокращение времени на разбор инцидентов - больше не нужно искать логи, и исследовать базы по заказу - тресы быстро покажут, где завис заказ.
3. Получать статстику о незавершенных/подвисших заказах - и тем самым выполнять ручной разбор проблем. 

### Важные метрики:

1. `SUBMITTED` => `PRICE_CALC_PENDING` - трейсинг покажет что заказ начал рассчитываться MES.
2. `PRICE_CALC_PENDING` => `PRICE_CALCULATED` - покажет длительность выполнения расчета.
3. `MANUFACTURING_STARTED` => `MANUFACTURING_COMPLETED` - позволит собирать данные о выполненных заказах операторами.


## Предлагаемое решение

### Выбор технологий

1. Подключить OpenTelemetry SDK - пакеты существуют для всех используемых языков программирования (Java, .NET, JS).
2. Развернуть OpenTelemetry Collector - для сбора трассировок.
3. Развернуть Jaeger (хранилище трейсов на базе Cassandra).
4. Развернуть JaegerUI для просмотра трассировок.

![jaeger-drawio](/Task3/jaeger-drawio.png)

### Автоматический мониторинг

Для автоматического срабатывания мониторинга следует использовать AlertManager, который уже развернут в системе, на этапе организации мониторинга.

![am-drawio](/Task3/am-drawio.png)

## Компромиссы

1. RabbitMQ не имеет встроенной поддержки с OpenTelemetry - traceId, spanId нужно будет передавать в header'ах событий.
2. Интеграция MES с OpenTelemetry является очень дорогой или даже невыполнимой задачей. Стоит избежать детализации расчета, и граничиться только статусами процесса, без детализации.

## Информационная безопасность

- Аавторизация в Grafana и Jaeger через корпоративный SSO;
- IP WhiteList по подсетям офисов комании;
- в данных трейсинга не должно быть чувствительных данных - только статусы, идентификаторы, временные метки и т д.;

# Пример реализации трейсинга в kubernetes

Интсрукция по запуску: [Task3/k8s-jaeger-sample/README.md](/Task3/k8s-jaeger-sample/README.md)

Пример трейса:
1) [Task3/k8s_jaeger_1.png](/Task3/k8s_jaeger_1.png)
![Task3/k8s_jaeger_1.png](/Task3/k8s_jaeger_1.png)

2) [Task3/k8s_jaeger_2.png](/Task3/k8s_jaeger_2.png)
![Task3/k8s_jaeger_2.png](/Task3/k8s_jaeger_2.png)

3) [Task3/k8s_jaeger_3.png](/Task3/k8s_jaeger_3.png)
![Task3/k8s_jaeger_3.png](/Task3/k8s_jaeger_3.png)

4) [Task3/k8s_jaeger_4.png](/Task3/k8s_jaeger_4.png)
![Task3/k8s_jaeger_4.png](/Task3/k8s_jaeger_4.png)