# Архитектурное решение по кешированию

На данный момент в системах компании "Александрит" отсутствует кэширование сервисных запросов. Это приводит к тому, что 
- операторы не могут быстро обрабатывать заказы, т.к. страницы MES медленно грузятся
- сами заказы обрабатываются медленно - есть проблемы и на бекенде MES Api.

## Мотивация

Озвученные проблемы, наиболее вероятно*, возникают по следующим причинам:
1. Повышенная нагрузка на MES DB
    - операторы часто отправляют запросы на чтение списка заказов
    - операторы загружают детализацию заказа, но данные расчета стоимости распределены по нескольким таблицам, и их сбор требует вычислительных ресурсов.
2. Отсутствие read-only реплики для базы данных.
    - и операторы, и пользователи партнерского Api могут слать запросы на чтение данных из базы, без каких-либо ограничений. Даже если запросы одинаковы, сейчас они каждый раз повторно вычисляются по таблицам базы данных.

*- предполагается, что мониторинг уже внедрен, и метрики подтверждают эту теорию.

Внедрение кэширования в интеграцию "MES API - MES DB" позволит:
1. Снизить количество запросов на формирование детализированного представления заказа
     - это сложный объект, который будет один раз собран по таблицам базы и сохранен в кэше, на случай повторных запросов.
2. Снизить нагрузку на чтение для получения списка заказов
    - данный сценарий идеально подходит под паттерн кэширования "Cache-Aside". Все что было прочитано, окажется в кэше, и при повторных запросах обращения в базу не будет.

## Предлагаемое решение

Тип подключаемого кэширования:
- Система: MES Api
- Тип кэширования: серверное
- Паттерн: Cache-Aside

### Почему именно "Cache-Aside"
Кроме предлагаемого паттерна кэширования "Cache-Aside" есть и другие. Но по ряду причин они не были выбраны:
1. "Read-Through" (чтение сквозь кэш) 
    - паттерн мог бы, частично, решить озвученные выше проблемы, но является более сложным в реализации, и избыточен в данной ситуации.
    - при данном подходе, модели данных в кэше должны соответствовать моделям данных в БД - а это делает невозможным хранение всей детализации расчета "одним объектом".
2. "Refresh-ahead" (асинхронное обновление данных в кэше) - данный паттерн подходит к текущей систуации.Однако есть и минусы:
    - паттерн чувствителен к сбоям чтения базы данных. Если фоновое обновление перестанет работать - клиенты начнуть видеть неактуальные данные. Это могло бы быть нивелировано мониторингом и алертами, но они тоже только внедряются, и, по этой причине, использование данного подхода не рекомендуется.
3. "Write-Through", "Write-Behind" - паттерны для оптимизации записи, а не чтения.

### Процесс взаимодействия систем

В MES Api Требуется сделать доработоку:
1. При запросе списка заказов проверить, есть ли заказы в кэше
    - Если есть - вернуть заказы из кэша
    - Если нет - получить заказы из базы, положить в кэш, вернуть полученные заказы
2. При появлении нового заказа, либо при запросах на обновление существующего заказа - обновить данные по заказу в кэше

Последовательность действий для использования кэша:
![sequence-cache-use](Cache-Aside%20for%20MES%20Api.png)

### Инвалидация кэша

Предполагается использование двух стратегий инвалидации кэша:
1. По ключу
    - при обновлении заказа его кэш должен быть удален, и добавлен обратно, в актуальном состоянии
2. По времени:
    - периодически весь кэш должен быть сброшен. Тогда, согласно паттерну Cache-Aside кэш восстановится.
    - можно настроить очистку всех ключей, как BackgroundService в MES API

