# Архитектурное решение по логированию

## Планирование

Требуется организовать сбор логов из систем

| Система | Технолгии |
|---------|-----------|
| Shop Api  | Spring Boot  |
| CRM Api   | Spring Boot  |
| MES Api   |  C#    |
| Internet Shop | Vue, TypeScript, Threejs  |
| CRM       | Vue, typescript    |
| MES       | React, typescript  |


Основные процессы, которые требуется фиксировать в логах:
1. Процесс обработки заказов
    - Описание: процесс выполнения заказов должен подробно фиксироваться на каждом шаге.
    - Поля: Номер заказа, статус, время, система, traceId, spanId
    - Уровни: INFO, ERROR
2. API запросы во все системы (Shop, CRM, MES)
    - Описание: все клиентские действия (как успешные, так и ошибки) должны фиксироваться в системе.
    - Поля: время, метод, параметры, код ответа, traceId, spanId
    - Уровни: INFO, ERROR
3. Интеграция с очередями RabbitMQ
    - Описание: каждая публикация и чтение сообщений из очереди должны фиксироваться, так как и факты подтверждения обработки (ack).
    - Поля: время, messageId, queue, действие, номер заказа, traceId, spanId
    - Уровни: INFO, ERROR
4. Работа с S3 файловым хранилищем.
    - Описание: запись, удаление и изменение файлов 3D-моделей системой долны логироваться.
    - Поля: время, номер заказа, имя файла, действие, traceId, spanId
    - Уровни: INFO

## Мотивация

Внедрение логирования позволит повысить наблюдаемость систем:
- По каждому заказу, или любому другому действию пользователя в логах будут задокументированы действия. 
- Логирование позволит быстрее решать инциденты пользователей и партнеров.
- По зависшим заказам можно будет найти причину зависания, и устранить причины, чтобы они более не возникали.

В первую очередь, логирование стоит внедрить в системы:
- CRM Api
- Shop Api
- MES Api

## Предлагаемое решение

### Технологии

Для хранения логов следует использовать проверенный и надежный стек технологий - ELK:
- Elastic - для хранения логов
- Logstach + Beats - для сбора логов
- Kibana - для визуализации 

На сервера системы потребуется установить компонент "Filebeat", который будет переливать логи из файлов в общее хранилище.

Выбор основан на сравнительных показателях, указанных ниже.
Splunk хоть и значительно выигрывает по всем пунктам, но является дорогостоящим решением, и функционал ELK будет достаточен.

|Критерий|     ELK|     OpenSearch|     Splunk|    Loki|
|---|---|---|---|---|
|Лицензия|Elastic License|Apache License, Version 2.0|Проприетарная| Apache License, Version 2.0  |
| Наличие возможностей | Достаточно | Достаточно | Даже больше чем требуется  | Ограниченно |
| Масштабируемость | Средняя | Средняя	| Высокая	| Низкая |
| Поддержка | OpenSource | 	OpenSource |  Коммерческая  |  OpenSource |

Схема реализации сбора логов:
![C4-logs](/Task4/logs-c4.png)

### Безопасность

- В логах не должно быть чувствительных данных (ФИО, emal, паспортные данные, данные счетов)
- Там, где чувствительные данные все же требуются для логирования (например email в операции авторизации) - они должны быть замаскированы.
- Доступ к Kibana должен быть только через SSO-авторизацию под доменным учетными записями. 
- Доступ на чтение следует предоставить сотрудникам ИТ отдела: SRE, DevOps, разработчики, QA

### Хранение

1. Индексы: на каждую систему отдельный индекс:
    - shop-*
    - crm-*
    - mes-*
2. Срок хранения:
    - dev: 3 дня
    - release: 7 дней
    - prod: не менее 30 дней (требуется скорректировать после уточнения объемов. Лучше дольше)
3. Размер логов оценить пока не представляется возможным. Ожидается 
- не менее 1 Гб в день от каждой системы.
- не менее 90 Гб в месяц.

## Процесс анализа логов

Кроме преимуществ, описанных выше, система логирования так же может и дополнить систему мониторинга дополнительными алертами:
1. Большой рост количества запросов с одного IP (вероятно DDOS-атака)
2. Превышение допустимого количества ошибок определенного типа (например ошибки публикации событий в RabbitMQ могут сигнализировать о недоступности сервиса)
2. Отсутсвие логов по старту нового этапа заказа после завершения предыдущего (вероятно зависание системы)



